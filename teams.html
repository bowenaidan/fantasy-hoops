<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fantasy Hoops Teams</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg-gradient-start: #0f172a;
      --bg-gradient-end: #1e293b;
      --card-bg: rgba(15, 23, 42, 0.82);
      --card-border: rgba(148, 163, 184, 0.35);
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.14);
      --table-header-bg: rgba(56, 189, 248, 0.12);
      --table-row-hover: rgba(56, 189, 248, 0.08);
      --table-border: rgba(148, 163, 184, 0.25);
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg-gradient-start: #f8fafc;
        --bg-gradient-end: #e2e8f0;
        --card-bg: rgba(255, 255, 255, 0.94);
        --card-border: rgba(15, 23, 42, 0.08);
        --text-primary: #0f172a;
        --text-secondary: #475569;
        --accent: #0284c7;
        --accent-soft: rgba(2, 132, 199, 0.12);
        --table-header-bg: rgba(2, 132, 199, 0.08);
        --table-row-hover: rgba(2, 132, 199, 0.06);
        --table-border: rgba(15, 23, 42, 0.08);
      }
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(160deg, var(--bg-gradient-start), var(--bg-gradient-end));
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      color: var(--text-primary);
      padding: 48px 24px;
      line-height: 1.6;
    }

    .page {
      width: min(1200px, 100%);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    h1 {
      margin: 0;
      font-size: clamp(2rem, 3vw, 2.6rem);
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    h2 {
      margin: 0;
      font-size: clamp(1.3rem, 2.2vw, 1.6rem);
      letter-spacing: -0.01em;
    }

    .description {
      margin: 4px 0 0;
      color: var(--text-secondary);
      font-size: 1rem;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.2);
      backdrop-filter: blur(10px);
    }

    .tabs {
      display: flex;
      justify-content: flex-start;
      align-items: center;
    }

    .tab-list {
      display: inline-flex;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 6px;
      gap: 6px;
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.18);
    }

    .tab-button {
      border: none;
      background: transparent;
      color: var(--text-secondary);
      padding: 10px 16px;
      border-radius: 12px;
      font-weight: 700;
      letter-spacing: 0.01em;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
      font-size: 1rem;
    }

    .tab-button:hover,
    .tab-button:focus-visible {
      background: var(--accent-soft);
      color: var(--accent);
      outline: none;
      transform: translateY(-1px);
    }

    .tab-button.active {
      background: var(--accent);
      color: #0b1224;
      box-shadow: 0 10px 24px rgba(56, 189, 248, 0.35);
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .panel-card {
      margin-top: 12px;
    }

    .dropdown-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-top: 16px;
    }

    .search-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 16px 0 12px;
      flex-wrap: wrap;
      color: var(--text-secondary);
    }

    .search-input {
      flex: 1 1 300px;
      padding: 12px 14px;
      border: 1px solid var(--card-border);
      border-radius: 12px;
      font-size: 1rem;
      background: rgba(148, 163, 184, 0.08);
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }

    .search-input::placeholder {
      color: var(--text-secondary);
    }

    .search-input:focus-visible {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
      background: rgba(56, 189, 248, 0.12);
    }

    .search-hint {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    details.manager-dropdown {
      background: rgba(15, 23, 42, 0.2);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      overflow: hidden;
      backdrop-filter: blur(12px);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.25);
    }

    .manager-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 18px 20px;
      cursor: pointer;
      list-style: none;
      background: var(--card-bg);
    }

    .summary-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .summary-title .manager-name {
      margin: 0;
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 0.01em;
    }

    .manager-name button,
    .manager-name strong {
      font: inherit;
    }

    .manager-points {
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 0.02em;
      font-size: 1.1rem;
      white-space: nowrap;
    }

    .summary-hint {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .manager-teams {
      border-top: 1px solid var(--card-border);
      padding: 16px 16px 18px;
      background: rgba(148, 163, 184, 0.08);
    }

    .teams-table-wrapper {
      overflow-x: auto;
      width: 100%;
      border-radius: 14px;
      border: 1px solid var(--table-border);
      background: rgba(15, 23, 42, 0.2);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 320px;
    }

    th, td {
      padding: 12px 14px;
      border-bottom: 1px solid var(--table-border);
      text-align: left;
      font-size: 0.98rem;
      color: var(--text-primary);
      word-break: break-word;
    }

    th {
      background: var(--table-header-bg);
      font-weight: 700;
      color: var(--text-secondary);
      position: sticky;
      top: 0;
      z-index: 1;
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    tbody tr:nth-child(even) {
      background: rgba(56, 189, 248, 0.08);
    }

    tbody tr:hover {
      background: var(--table-row-hover);
    }

    .points-gain {
      color: #16a34a;
      font-weight: 700;
    }

    .points-loss {
      color: #ef4444;
      font-weight: 700;
    }

    .empty-state {
      color: var(--text-secondary);
      font-size: 0.98rem;
      margin: 6px 0 0;
    }

    .search-results table {
      min-width: 0;
    }

    .pill {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .error {
      color: #b91c1c;
      background: #fee2e2;
      padding: 10px 14px;
      border: 1px solid #fecdd3;
      border-radius: 8px;
      margin-top: 12px;
    }

    @media (max-width: 768px) {
      body {
        padding: 32px 16px;
      }

      .card,
      details.manager-dropdown {
        border-radius: 18px;
      }

      .manager-summary {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      table,
      thead,
      tbody,
      th,
      td,
      tr {
        display: block;
      }

      thead {
        display: none;
      }

      tr {
        margin-bottom: 12px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 14px;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.18);
      }

      td {
        border-bottom: 1px solid var(--card-border);
        position: relative;
        padding: 12px 12px 12px 44%;
        font-size: 1rem;
      }

      td:last-child {
        border-bottom: none;
      }

      td::before {
        content: attr(data-label);
        position: absolute;
        left: 12px;
        top: 12px;
        font-weight: 700;
        color: var(--text-secondary);
        font-size: 0.9rem;
        text-transform: capitalize;
      }

      .teams-table-wrapper {
        overflow: visible;
        border: none;
        background: transparent;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <h1>Teams</h1>
      <p class="description">
        Live view of the TEAMS sheet with teams grouped by manager. Expand a manager to view their teams.
      </p>
      <div class="tabs" role="tablist">
        <div class="tab-list">
          <button class="tab-button active" data-tab="manager" role="tab" aria-selected="true">By manager</button>
          <button class="tab-button" data-tab="search" role="tab" aria-selected="false">Search teams</button>
        </div>
      </div>
    </div>

    <!-- <section>
      <h2>Manager totals</h2>
      <ul id="managerTotals" class="manager-totals"></ul>
    </section> -->

    <section id="managerTab" class="tab-panel active" aria-label="Teams by manager">
      <div class="card panel-card">
        <h2>Teams by manager</h2>
        <div id="managerDropdowns" class="dropdown-list"></div>
      </div>
    </section>

    <section id="searchTab" class="tab-panel" aria-label="Search teams">
      <div class="card panel-card">
        <h2>Search by team</h2>
        <div class="search-bar">
          <input id="teamSearch" class="search-input" type="search" placeholder="Start typing a team name" aria-label="Search teams" />
          <span class="search-hint">Ordered by total points (high to low)</span>
        </div>
        <div id="searchResults" class="search-results"></div>
      </div>
    </section>

    <div id="error" class="error" style="display:none;"></div>
  </div>

  <script>
    const columns = [
      'team',
      'points',
    ];

    const searchColumns = [
      'team',
      'points',
      'manager',
      'opponent',
    ];

    let allTeams = [];

    function renderManagerTotals(managerTotals) {
      const list = document.getElementById('managerTotals');
      list.innerHTML = '';

      managerTotals.forEach(({ manager, totalPoints }) => {
        const item = document.createElement('li');
        item.className = 'manager-card';
        item.innerHTML = `
          <p class="manager-name">${manager}</p>
          <div><strong>Total Points:</strong> ${totalPoints}</div>
        `;
        list.appendChild(item);
      });
    }

    function formatColumnName(column) {
      const label = column.replace(/_/g, ' ');
      return label.charAt(0).toUpperCase() + label.slice(1);
    }

    function formatTeamLabel(team) {
      const teamName = team?.team ?? '';
      const rank = team?.rank;
      return rank ? `${teamName} (${rank})` : teamName;
    }

    function formatOpponentLabel(team) {
      const opponentName = team?.opponent ?? '';
      const opponentRank = team?.opponent_rank;
      return opponentRank ? `${opponentName} (${opponentRank})` : opponentName;
    }

    function getTotalPoints(team) {
      const base = Number(team?.points) || 0;
      const today = Number(team?.points_today) || 0;
      return base + today;
    }

    function renderManagerDropdowns(managerTotals, teams, managerDailyTotal = []) {
      const dailyByManager = managerDailyTotal.reduce((acc, row) => {
        acc[row.manager] = row.dailyPoints;
        return acc;
      }, {});
      const dropdownList = document.getElementById('managerDropdowns');
      dropdownList.innerHTML = '';

      const teamsByManager = teams.reduce((acc, team) => {
        const manager = team?.manager || 'Unassigned';
        if (!acc.has(manager)) {
          acc.set(manager, []);
        }
        acc.get(manager).push(team);
        return acc;
      }, new Map());

      managerTotals.forEach(({ manager, totalPoints }) => {
        const managerTeams = (teamsByManager.get(manager) || []).sort((a, b) => {
          const pointsA = Number(a?.points) || 0;
          const pointsB = Number(b?.points) || 0;
          if (pointsB !== pointsA) return pointsB - pointsA;
          return (a?.team || '').localeCompare(b?.team || '');
        });

        const daily = dailyByManager[manager] ?? 0;

        let dailyClass = '';
        let dailyHtml = '';

        if (daily > 0) {
          dailyClass = 'points-gain';
          dailyHtml = `<span class="${dailyClass}">+${daily}</span>`;
        } else if (daily < 0) {
          dailyClass = 'points-loss';
          dailyHtml = `<span class="${dailyClass}">${daily}</span>`;
        }
        const details = document.createElement('details');
        details.className = 'manager-dropdown';

        const summary = document.createElement('summary');
        summary.className = 'manager-summary';
        summary.innerHTML = `
          <div class="summary-title">
            <p class="manager-name">${manager}</p>
            <span class="summary-hint">Click to view team details</span>
          </div>
          <span class="manager-points">
            ${dailyHtml} ${totalPoints + daily} pts
          </span>
        `;

        const teamsContainer = document.createElement('div');
        teamsContainer.className = 'manager-teams';

        if (!managerTeams.length) {
          const empty = document.createElement('p');
          empty.className = 'empty-state';
          empty.textContent = 'No teams assigned to this manager.';
          teamsContainer.appendChild(empty);
        } else {
          const wrapper = document.createElement('div');
          wrapper.className = 'teams-table-wrapper';

          const table = document.createElement('table');
          const thead = document.createElement('thead');
          const headerRow = document.createElement('tr');
          columns.forEach(col => {
            const th = document.createElement('th');
            th.textContent = formatColumnName(col);
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);

          const tbody = document.createElement('tbody');
          managerTeams.forEach(team => {
            const row = document.createElement('tr');
            columns.forEach(col => {
              const td = document.createElement('td');
              td.dataset.label = formatColumnName(col);
              if (col === 'team') {
                const teamName = team[col] ?? '';
                const rank = team?.rank;
                const opponentName = team?.opponent;
                const opponentRank = team?.opponent_rank;

                const teamTitle = document.createElement('strong');
                teamTitle.textContent = rank ? `${teamName} (${rank})` : teamName;
                td.appendChild(teamTitle);

                const opponentDetails = [
                  opponentName ? `vs ${opponentName}` : null,
                  opponentRank ? `(${opponentRank})` : null,
                ].filter(Boolean).join(' ');

                if (opponentDetails) {
                  const opponentSpan = document.createElement('span');
                  opponentSpan.textContent = ` ${opponentDetails}`;
                  td.appendChild(opponentSpan);
                }
              } else if (col === 'opponent') {
                const opponentName = team[col] ?? '';
                const opponentRank = team?.opponent_rank;
                td.textContent = opponentRank ? `${opponentName} (${opponentRank})` : opponentName;
              } else if (col === 'points') {
                const pointsToday = Number(team.points_today) || 0;
                const potentialPoints = Number(team.potential_points) || 0;
                const details = [];

                // if (potentialPoints !== 0 && potentialPoints !== pointsToday) {
                //   details.push(`${potentialPoints > 0 ? `(+${potentialPoints})` : potentialPoints}`);
                // }

                const detailText = details.length ? ` ${details.join(', ')}` : '';
                td.textContent = `${team[col] + pointsToday ?? ''}`;

                if((potentialPoints !== 0) && (potentialPoints !== pointsToday)) {
                  const pointsTodaySpan = document.createElement('span');
                  pointsTodaySpan.textContent = ` (+${potentialPoints})`;
                  td.appendChild(pointsTodaySpan);
                }

                if (pointsToday) {
                  if (pointsToday > 0){
                    const pointsTodaySpan = document.createElement('span');
                    pointsTodaySpan.className = 'points-gain';
                    pointsTodaySpan.textContent = ` +${pointsToday}`;
                    td.appendChild(pointsTodaySpan);
                  }
                  else {
                    const pointsTodaySpan = document.createElement('span');
                    pointsTodaySpan.className = 'points-loss';
                    pointsTodaySpan.textContent = ` ${pointsToday}`;
                    td.appendChild(pointsTodaySpan);
                  }
                }
              } else {
                td.textContent = team[col] ?? '';
              }
              row.appendChild(td);
            });
            tbody.appendChild(row);
          });

          table.appendChild(thead);
          table.appendChild(tbody);
          wrapper.appendChild(table);
          teamsContainer.appendChild(wrapper);
        }

        details.appendChild(summary);
        details.appendChild(teamsContainer);
        dropdownList.appendChild(details);
      });
    }

    function renderTeamSearch(teams, filter = '') {
      const query = filter.trim().toLowerCase();
      const results = document.getElementById('searchResults');
      results.innerHTML = '';

      const filteredTeams = teams
        .filter(team => {
          if (!query) return true;
          const name = String(team?.team || '').toLowerCase();
          return name.includes(query);
        })
        .sort((a, b) => {
          const totalA = getTotalPoints(a);
          const totalB = getTotalPoints(b);
          if (totalB !== totalA) return totalB - totalA;
          return formatTeamLabel(a).localeCompare(formatTeamLabel(b));
        });

      if (!filteredTeams.length) {
        const empty = document.createElement('p');
        empty.className = 'empty-state';
        empty.textContent = 'No teams match your search.';
        results.appendChild(empty);
        return;
      }

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      searchColumns.forEach(col => {
        const th = document.createElement('th');
        th.textContent = formatColumnName(col);
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      const tbody = document.createElement('tbody');
      filteredTeams.forEach(team => {
        const row = document.createElement('tr');
        searchColumns.forEach(col => {
          const td = document.createElement('td');
          td.dataset.label = formatColumnName(col);

          if (col === 'team') {
            const teamLabel = document.createElement('strong');
            teamLabel.textContent = formatTeamLabel(team);
            td.appendChild(teamLabel);
          } else if (col === 'points') {
            td.textContent = getTotalPoints(team);
          } else if (col === 'opponent') {
            td.textContent = formatOpponentLabel(team);
          } else {
            td.textContent = team[col] ?? '';
          }

          row.appendChild(td);
        });
        tbody.appendChild(row);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      results.appendChild(table);
    }

    function setupTabs() {
      const buttons = Array.from(document.querySelectorAll('.tab-button'));
      buttons.forEach(button => {
        button.addEventListener('click', () => {
          const target = button.dataset.tab;
          buttons.forEach(b => {
            const isActive = b.dataset.tab === target;
            b.classList.toggle('active', isActive);
            b.setAttribute('aria-selected', isActive);
          });

          document.querySelectorAll('.tab-panel').forEach(panel => {
            panel.classList.toggle('active', panel.id === `${target}Tab`);
          });
        });
      });
    }

    function showError(message) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }

    function initialize() {
      setupTabs();

      google.script.run
        .withSuccessHandler(({ teams, managerTotals, managerDailyTotal }) => {
          allTeams = teams || [];
          // renderManagerTotals(managerTotals);
          renderManagerDropdowns(managerTotals, teams, managerDailyTotal);
          renderTeamSearch(allTeams);

          const searchInput = document.getElementById('teamSearch');
          searchInput.addEventListener('input', (event) => {
            renderTeamSearch(allTeams, event.target.value || '');
          });
        })
        .withFailureHandler(err => {
          const message = err && err.message ? err.message : 'Unable to load teams data.';
          showError(message);
        })
        .getTeamsPageData();
    }

    initialize();
  </script>
</body>
</html>
